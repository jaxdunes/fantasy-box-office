<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantasy Box Office League</title>
  <style>
    :root{
      --bg0:#070815;
      --bg1:#0a0b1a;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.44);
      --good: rgba(140,255,190,.95);
      --bad: rgba(255,150,150,.95);
      --warn: rgba(255,220,140,.95);
      --shadow: 0 22px 60px rgba(0,0,0,.55);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);
      --r: 18px;
      --r2: 22px;
      --pad: 18px;
      --posterW: 160px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 22% 12%, rgba(140,120,255,.25), transparent 60%),
        radial-gradient(1000px 600px at 78% 22%, rgba(50,220,200,.18), transparent 55%),
        radial-gradient(900px 700px at 55% 80%, rgba(255,120,160,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 34px 18px 60px;
    }

    .hero{
      border-radius: 28px;
      padding: 26px 26px 22px;
      background:
        radial-gradient(900px 260px at 25% 10%, rgba(170,130,255,.22), transparent 55%),
        radial-gradient(900px 260px at 75% 10%, rgba(80,220,210,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .kicker{
      display:flex; align-items:center; gap:10px;
      font-size: 12px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: rgba(255,255,255,.60);
      margin-bottom: 10px;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background: rgba(90,255,180,.9);
      box-shadow: 0 0 0 6px rgba(90,255,180,.12);
    }
    h1{
      margin:0;
      font-size: 44px;
      line-height: 1.05;
      letter-spacing: -0.03em;
    }
    .sub{
      margin-top:10px;
      max-width: 70ch;
      color: rgba(255,255,255,.70);
      font-size: 14px;
      line-height: 1.45;
    }

    .topbar{
      margin-top: 16px;
      display:flex;
      flex-wrap: wrap;
      align-items:center;
      gap: 10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 12px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      color: rgba(255,255,255,.78);
      font-size: 12px;
    }
    .pill strong{color: rgba(255,255,255,.92); font-weight: 650;}
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18);}
    .btn:active{transform: translateY(1px);}

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      margin-top: 18px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r2);
      box-shadow: 0 18px 50px rgba(0,0,0,.38);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .card .head{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.09);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .hint{
      color: rgba(255,255,255,.55);
      font-size: 12px;
      margin-top: 2px;
    }
    .body{padding: 14px;}

    .search{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.90);
      outline:none;
      font-size: 13px;
    }
    .search::placeholder{color: rgba(255,255,255,.40);}

    .standings{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      transition: background .2s ease, border-color .2s ease, transform .06s ease;
    }
    .row:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.14);}
    .row:active{transform: translateY(1px);}
    .row.active{
      background: rgba(140,120,255,.14);
      border-color: rgba(170,150,255,.28);
    }
    .row .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .rank{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      font-size: 12px;
      font-weight: 750;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.82);
      flex: 0 0 auto;
    }
    .name{
      font-weight: 700;
      font-size: 13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      font-size: 12px;
      color: rgba(255,255,255,.60);
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .money{
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .01em;
    }
    .money.pos{color: var(--good);}
    .money.neg{color: var(--bad);}

    .empty{
      color: rgba(255,255,255,.58);
      font-size: 13px;
      padding: 14px;
      border: 1px dashed rgba(255,255,255,.16);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    .errorbox{
      color: rgba(255,170,170,.95);
      font-size: 12px;
      line-height: 1.35;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,160,160,.22);
      background: rgba(255,80,80,.08);
    }

    /* Player detail */
    .playerTitle{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
    }
    .playerTitle .big{
      font-size: 20px;
      font-weight: 850;
      letter-spacing: -0.02em;
      margin:0;
    }
    .smallMeta{
      color: rgba(255,255,255,.58);
      font-size: 12px;
    }

    .section{
      margin-top: 14px;
    }
    .section h3{
      margin: 0 0 10px;
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(255,255,255,.62);
      display:flex; align-items:center; gap:10px;
    }
    .chips{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: rgba(255,255,255,.78);
    }
    .chip strong{color: rgba(255,255,255,.92)}
    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 14px 0;
    }

    /* Poster grid inside player detail */
    .posterGrid{
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }
    .movieTile{
      width: var(--posterW);
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .poster{
      width: 100%;
      aspect-ratio: 2 / 3; /* poster shape */
      object-fit: cover;
      border-radius: 16px;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }
    .movieTitle{
      font-size: 13px;
      line-height: 1.2;
      font-weight: 700;
      color: rgba(255,255,255,.90);
    }
    .profitLine{
      font-size: 12px;
      letter-spacing: .2px;
      color: rgba(255,255,255,.68);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .profitLine .val{font-weight: 800;}
    .profitLine .val.pos{color: var(--good);}
    .profitLine .val.neg{color: var(--bad);}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.76);
    }
    .badge.bomb{
      border-color: rgba(255,160,160,.26);
      background: rgba(255,80,80,.10);
      color: rgba(255,190,190,.92);
    }
    .badge.hit{
      border-color: rgba(140,255,190,.22);
      background: rgba(80,255,140,.10);
      color: rgba(180,255,220,.92);
    }

    /* Upcoming scroller */
    .upHead{
      display:flex; align-items:baseline; justify-content:space-between; gap:12px;
    }
    .upSub{
      color: rgba(255,255,255,.55);
      font-size: 12px;
      margin-top: 4px;
    }
    .scroller{
      margin-top: 10px;
      display:flex;
      gap: 12px;
      overflow:auto;
      padding-bottom: 8px;
      scroll-snap-type: x mandatory;
    }
    .scroller::-webkit-scrollbar{height:10px}
    .scroller::-webkit-scrollbar-thumb{background: rgba(255,255,255,.10); border-radius: 999px}
    .scroller::-webkit-scrollbar-track{background: rgba(0,0,0,.15); border-radius: 999px}

    .upCard{
      flex: 0 0 auto;
      width: 210px;
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 32px rgba(0,0,0,.32);
      overflow:hidden;
      scroll-snap-align: start;
      position:relative;
    }
    .upPoster{
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      display:block;
      background: rgba(255,255,255,.06);
    }
    .upInfo{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .upTitle{
      font-size: 13px;
      font-weight: 800;
      line-height: 1.15;
    }
    .upMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.62);
    }
    .ownerPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width: 70%;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .avatar{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      font-size: 12px;
      font-weight: 800;
      color: rgba(255,255,255,.84);
      flex: 0 0 auto;
    }

    .footerNote{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      color: rgba(255,255,255,.40);
      font-size: 11px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="kicker"><span class="dot"></span><span>Q1 • SPLIT BOMBS • LIVE STANDINGS</span></div>
      <h1>Fantasy Box Office League</h1>
      <div class="sub">
        Scores update from your Google Sheet. Hits earn their own profit. Bombs are split across opponents (negative exposure).
      </div>

      <div class="topbar">
        <div class="pill"><span class="dot" style="width:7px;height:7px;box-shadow:none;background:rgba(255,255,255,.35)"></span><strong id="liveStatus">Live</strong></div>
        <div class="pill"><span>Updated:</span> <strong id="updatedAt">—</strong></div>
        <div class="pill"><span id="playerCount">0 players</span></div>
        <button class="btn" id="refreshBtn">⟳ Refresh now</button>
        <button class="btn" id="clearBtn">× Clear selection</button>
      </div>

      <div id="topError" style="margin-top:12px; display:none;"></div>

      <div class="grid">
        <div class="card">
          <div class="head">
            <div>
              <h2>Standings</h2>
              <div class="hint">Tap a player to expand</div>
            </div>
            <div class="hint" id="standingsCount">—</div>
          </div>
          <div class="body">
            <input class="search" id="search" placeholder="Search players..." />
            <div class="standings" id="standings"></div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div>
              <h2 id="detailTitle">Select a player</h2>
              <div class="hint" id="detailHint">Their roster will appear here.</div>
            </div>
          </div>
          <div class="body" id="detailBody">
            <div class="empty">Pick someone on the left to view their hits + bomb exposure.</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <div class="head">
          <div class="upHead">
            <div>
              <h2>Upcoming Releases</h2>
              <div class="upSub">Only chosen, unreleased movies (profit = $0). Bombs show as “Bomb” (no names).</div>
            </div>
          </div>
        </div>
        <div class="body">
          <div id="upcomingError" style="display:none;"></div>
          <div class="scroller" id="upcoming"></div>
        </div>
      </div>

      <div class="footerNote">
        <div>Hosted on GitHub Pages · Dark / Cinematic theme</div>
        <div class="mono">Auto-refresh: every 30s · Cache-bust enabled</div>
      </div>
    </div>
  </div>

<script>
/**
 * ✅ SET THIS to your published CSV (API tab).
 * It MUST return comma-separated text with header row that includes "player".
 */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8g_VBKkleUsEkvhsj-Gs4Xsk5k9RifmPFUHw8Yq0_K5X8cca9p1or8TBNI5UbfglWT-A6uVSed_tX/pub?output=csv";

/**
 * OPTIONAL: If you later publish a MOVIES CSV (with columns like key/profit/release_date),
 * you can set MOVIES_CSV_URL and we’ll use it for profit lookups.
 * If not set / fails, we fall back to totals coming from the API CSV (player totals).
 */
// const MOVIES_CSV_URL = "";

let STATE = {
  rows: [],
  selectedPlayer: null,
  lastUpdated: null
};

function normKey(s){
  return String(s||"")
    .replace(/\u00A0/g," ")
    .trim()
    .toLowerCase();
}

function fmtMoney(n){
  const v = Number(n || 0);
  const abs = Math.abs(v);
  const sign = v < 0 ? "−" : "";
  if (abs >= 1e9) return `${sign}$${(abs/1e9).toFixed(2)}B`;
  if (abs >= 1e6) return `${sign}$${(abs/1e6).toFixed(1)}M`;
  if (abs >= 1e3) return `${sign}$${(abs/1e3).toFixed(1)}K`;
  return `${sign}$${abs.toFixed(0)}`;
}

function moneyClass(v){ return Number(v||0) < 0 ? "neg" : "pos"; }

function safeImg(url){
  const u = String(url||"").trim();
  return u || "";
}

function avatarLetter(name){
  const n = String(name||"").trim();
  return n ? n[0].toUpperCase() : "?";
}

/** Minimal CSV parser that handles quotes */
function parseCSV(text){
  // strip BOM
  text = String(text||"").replace(/^\uFEFF/, "");
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i=0; i<text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (inQuotes){
      if (c === '"' && next === '"'){ cur += '"'; i++; }
      else if (c === '"'){ inQuotes = false; }
      else { cur += c; }
    } else {
      if (c === '"'){ inQuotes = true; }
      else if (c === ','){ row.push(cur); cur=""; }
      else if (c === '\n'){
        row.push(cur); cur="";
        // ignore completely empty trailing rows
        if (row.some(x => String(x).trim() !== "")) rows.push(row);
        row = [];
      } else if (c === '\r'){
        // ignore
      } else {
        cur += c;
      }
    }
  }
  row.push(cur);
  if (row.some(x => String(x).trim() !== "")) rows.push(row);
  return rows;
}

function showTopError(msg){
  const box = document.getElementById("topError");
  if (!msg){
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }
  box.style.display = "block";
  box.innerHTML = `<div class="errorbox">${msg}</div>`;
}

function showUpcomingError(msg){
  const box = document.getElementById("upcomingError");
  if (!msg){
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }
  box.style.display = "block";
  box.innerHTML = `<div class="errorbox">${msg}</div>`;
}

function setUpdated(){
  const el = document.getElementById("updatedAt");
  el.textContent = STATE.lastUpdated ? STATE.lastUpdated.toLocaleString() : "—";
}

async function fetchCSV(url){
  const u = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
  const res = await fetch(u, { cache: "no-store" });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
  return await res.text();
}

function rowsToObjects(csvText){
  const rows = parseCSV(csvText);
  if (!rows.length) return [];
  const header = rows[0].map(h => normKey(h));
  const dataRows = rows.slice(1);

  const objs = dataRows.map(r => {
    const o = {};
    for (let i=0; i<header.length; i++){
      const k = header[i] || `col_${i}`;
      o[k] = (r[i] ?? "").toString().trim();
    }
    return o;
  });

  return { header, objs };
}

function validateAPIHeader(header){
  // Some people accidentally publish the wrong sheet (like DASHBOARD) and it returns weird headers.
  // We require "player" to be present.
  return header.includes("player");
}

function getPickedMoviesFromRow(r){
  // Your API CSV columns are like:
  // hit1, hit1_poster, hit2, hit2_poster, hit3, hit3_poster,
  // bomb1, bomb1_poster ... bomb6, bomb6_poster
  const hits = [];
  const bombs = [];
  for (let i=1;i<=3;i++){
    const title = r[`hit${i}`] || "";
    const poster = r[`hit${i}_poster`] || "";
    if (String(title).trim() !== ""){
      hits.push({ title: String(title).trim(), poster: safeImg(poster), kind:"hit", share: 1 });
    }
  }
  for (let i=1;i<=6;i++){
    const title = r[`bomb${i}`] || "";
    const poster = r[`bomb${i}_poster`] || "";
    if (String(title).trim() !== ""){
      // In your sheet bombs are shared (often 1/6). We’ll try to read "share" if present, else assume 1/6.
      const share = Number(r["share"] || r["bomb_share"] || (1/6));
      bombs.push({ title: String(title).trim(), poster: safeImg(poster), kind:"bomb", share: isFinite(share) ? share : (1/6) });
    }
  }
  return { hits, bombs };
}

function renderStandings(){
  const standingsEl = document.getElementById("standings");
  standingsEl.innerHTML = "";

  const q = normKey(document.getElementById("search").value);
  const filtered = STATE.rows.filter(r => !q || normKey(r.player).includes(q));

  document.getElementById("standingsCount").textContent = `${filtered.length} players`;
  document.getElementById("playerCount").textContent = `${STATE.rows.length} players`;

  if (!filtered.length){
    standingsEl.innerHTML = `<div class="empty">No players found.</div>`;
    return;
  }

  filtered.forEach((r, idx) => {
    const total = Number(r.total || 0);
    const { hits, bombs } = getPickedMoviesFromRow(r);

    const row = document.createElement("div");
    row.className = "row" + (STATE.selectedPlayer === r.player ? " active" : "");
    row.addEventListener("click", () => {
      STATE.selectedPlayer = r.player;
      renderStandings();
      renderDetail();
    });

    row.innerHTML = `
      <div class="left">
        <div class="rank">${idx+1}</div>
        <div style="min-width:0">
          <div class="name">${escapeHtml(r.player || "")}</div>
          <div class="meta">
            <span>Hits: <strong>${hits.length}</strong></span>
            <span>Bombs: <strong>${bombs.length}</strong></span>
          </div>
        </div>
      </div>
      <div class="money ${moneyClass(total)}">${fmtMoney(total)}</div>
    `;
    standingsEl.appendChild(row);
  });
}

function renderDetail(){
  const body = document.getElementById("detailBody");
  const title = document.getElementById("detailTitle");
  const hint = document.getElementById("detailHint");

  if (!STATE.selectedPlayer){
    title.textContent = "Select a player";
    hint.textContent = "Their roster will appear here.";
    body.innerHTML = `<div class="empty">Pick someone on the left to view their hits + bomb exposure.</div>`;
    return;
  }

  const r = STATE.rows.find(x => x.player === STATE.selectedPlayer);
  if (!r){
    title.textContent = "Select a player";
    hint.textContent = "Their roster will appear here.";
    body.innerHTML = `<div class="empty">Couldn’t find that player in the latest data.</div>`;
    return;
  }

  const total = Number(r.total || 0);
  const { hits, bombs } = getPickedMoviesFromRow(r);

  title.textContent = r.player;
  hint.textContent = "Hits (owned) and Bomb Exposure (shared).";

  const hitsHTML = hits.length ? renderPosterGrid(hits, r.player) : `<div class="empty">No hits yet.</div>`;
  const bombsHTML = bombs.length ? renderPosterGrid(bombs, r.player) : `<div class="empty">No bomb exposure yet.</div>`;

  body.innerHTML = `
    <div class="playerTitle">
      <div>
        <div class="big">${escapeHtml(r.player)}</div>
        <div class="smallMeta">Total: <span class="money ${moneyClass(total)}">${fmtMoney(total)}</span></div>
      </div>
      <div class="chips">
        <div class="chip"><span>Hits</span> <strong>${hits.length}</strong></div>
        <div class="chip"><span>Bombs</span> <strong>${bombs.length}</strong></div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="section">
      <h3>Hits</h3>
      ${hitsHTML}
    </div>

    <div class="section">
      <h3>Bomb Exposure</h3>
      ${bombsHTML}
    </div>
  `;
}

function renderPosterGrid(items, playerName){
  const gridId = "g_" + Math.random().toString(16).slice(2);
  // We’ll render the container now and fill tiles via DOM after innerHTML is set.
  setTimeout(() => {
    const grid = document.getElementById(gridId);
    if (!grid) return;

    items.forEach(it => {
      grid.appendChild(movieTile(it, playerName));
    });
  }, 0);

  return `<div class="posterGrid" id="${gridId}"></div>`;
}

/**
 * Profit display:
 * - Your API CSV doesn't include per-movie profit, only player totals.
 * - If you later publish MOVIES and wire it in, you can replace profitForTitle() to map title -> Profit To Date.
 * For now:
 *   - We show "$0" for each movie (until you add MOVIES CSV lookup),
 *   - BUT bombs will still show Exposure: $0 (or the computed number if you wire profit later).
 */
function profitForTitle(/*title*/){
  return 0;
}

function movieTile({ title, poster, kind="hit", share=1 }, playerName){
  const profit = profitForTitle(title);             // per-movie profit (optional wiring)
  const impact = kind === "bomb" ? (profit * Number(share || 0)) : profit;

  const wrap = document.createElement("div");
  wrap.className = "movieTile";

  const img = document.createElement("img");
  img.className = "poster";
  img.alt = title || "";
  img.referrerPolicy = "no-referrer"; // helps some hosts
  if (poster) img.src = poster;

  const t = document.createElement("div");
  t.className = "movieTitle";
  t.textContent = title || "";

  const line = document.createElement("div");
  line.className = "profitLine";

  const badge = document.createElement("span");
  badge.className = "badge " + (kind === "bomb" ? "bomb" : "hit");
  badge.textContent = kind === "bomb" ? "Bomb" : "Hit";

  const val = document.createElement("span");
  val.className = "val " + moneyClass(profit);
  val.textContent = fmtMoney(profit);

  const sub = document.createElement("span");
  sub.style.color = "rgba(255,255,255,.55)";
  sub.textContent = kind === "bomb" ? `Exposure: ${fmtMoney(impact)}` : `Owned: ${fmtMoney(impact)}`;

  // No names next to bomb picks (per your rule)
  // For hits, we *could* show owner, but you didn't ask for it in the player panel.
  line.appendChild(badge);
  line.appendChild(val);
  line.appendChild(sub);

  wrap.appendChild(img);
  wrap.appendChild(t);
  wrap.appendChild(line);

  return wrap;
}

function buildUpcoming(){
  const el = document.getElementById("upcoming");
  el.innerHTML = "";

  // Rules you asked for:
  // - Only chosen movies (not all MOVIES tab)
  // - Only unreleased movies in the scroller
  // - No names next to bomb picks
  //
  // We don't have release dates in the API CSV, so we interpret "unreleased" as:
  // - per-movie profit == 0 (works for your current workflow)
  //
  // It also means: when a movie starts earning, it'll naturally drop off.

  const chosen = [];
  const seen = new Set();

  STATE.rows.forEach(r => {
    const { hits, bombs } = getPickedMoviesFromRow(r);

    hits.forEach(m => {
      const k = normKey(m.title);
      if (!k || seen.has("hit:"+k)) return;
      seen.add("hit:"+k);
      chosen.push({
        ...m,
        owner: r.player,
      });
    });

    bombs.forEach(m => {
      const k = normKey(m.title);
      if (!k || seen.has("bomb:"+k)) return;
      seen.add("bomb:"+k);
      chosen.push({
        ...m,
        owner: null, // bombs = no owner shown
      });
    });
  });

  // unreleased filter
  const upcoming = chosen.filter(m => Number(profitForTitle(m.title) || 0) === 0);

  if (!upcoming.length){
    el.innerHTML = `<div class="empty" style="width:100%;">No upcoming chosen movies right now (profit = $0).</div>`;
    return;
  }

  upcoming.forEach(m => el.appendChild(upcomingCard(m)));
}

function upcomingCard(m){
  const card = document.createElement("div");
  card.className = "upCard";

  const img = document.createElement("img");
  img.className = "upPoster";
  img.alt = m.title || "";
  img.referrerPolicy = "no-referrer";
  if (m.poster) img.src = m.poster;

  const info = document.createElement("div");
  info.className = "upInfo";

  const title = document.createElement("div");
  title.className = "upTitle";
  title.textContent = m.title || "";

  const meta = document.createElement("div");
  meta.className = "upMeta";

  // left: owner pill OR blank for bombs
  const left = document.createElement("div");
  left.className = "ownerPill";

  const badge = document.createElement("span");
  badge.className = "badge " + (m.kind === "bomb" ? "bomb" : "hit");
  badge.textContent = m.kind === "bomb" ? "Bomb" : "Hit";

  left.appendChild(badge);

  if (m.kind !== "bomb" && m.owner){
    const av = document.createElement("span");
    av.className = "avatar";
    av.textContent = avatarLetter(m.owner);

    const nm = document.createElement("span");
    nm.style.overflow = "hidden";
    nm.style.textOverflow = "ellipsis";
    nm.style.whiteSpace = "nowrap";
    nm.textContent = m.owner;

    left.appendChild(av);
    left.appendChild(nm);
  }

  const right = document.createElement("div");
  right.style.opacity = ".8";
  right.textContent = "Upcoming"; // you asked to remove dates + keep it clean

  meta.appendChild(left);
  meta.appendChild(right);

  info.appendChild(title);
  info.appendChild(meta);

  card.appendChild(img);
  card.appendChild(info);

  return card;
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function build(){
  try{
    showTopError(null);
    showUpcomingError(null);

    const csvText = await fetchCSV(SHEET_CSV_URL);
    const { header, objs } = rowsToObjects(csvText);

    if (!validateAPIHeader(header)){
      // show what we found to make it obvious which sheet got published
      const found = header.slice(0, 10).join(", ");
      throw new Error(`CSV header missing "player". Found: ${found}`);
    }

    // normalize output object keys expected by code:
    // header is already normalized, so use those keys.
    const cleaned = objs.map(o => ({
      player: o["player"] || "",
      total: o["total"] || "0",
      hit1: o["hit1"] || "",
      hit1_poster: o["hit1_poster"] || "",
      hit2: o["hit2"] || "",
      hit2_poster: o["hit2_poster"] || "",
      hit3: o["hit3"] || "",
      hit3_poster: o["hit3_poster"] || "",
      bomb1: o["bomb1"] || "",
      bomb1_poster: o["bomb1_poster"] || "",
      bomb2: o["bomb2"] || "",
      bomb2_poster: o["bomb2_poster"] || "",
      bomb3: o["bomb3"] || "",
      bomb3_poster: o["bomb3_poster"] || "",
      bomb4: o["bomb4"] || "",
      bomb4_poster: o["bomb4_poster"] || "",
      bomb5: o["bomb5"] || "",
      bomb5_poster: o["bomb5_poster"] || "",
      bomb6: o["bomb6"] || "",
      bomb6_poster: o["bomb6_poster"] || "",
      hit_points: o["hit_points"] || "0",
      bomb_points: o["bomb_points"] || "0",
      share: o["share"] || o["bomb_share"] || "" // optional
    }))
    .filter(r => String(r.player).trim() !== "");

    // sort by total desc
    cleaned.sort((a,b) => Number(b.total||0) - Number(a.total||0));

    STATE.rows = cleaned;
    STATE.lastUpdated = new Date();

    setUpdated();
    renderStandings();
    renderDetail();
    buildUpcoming();

    document.getElementById("liveStatus").textContent = "Live";
  } catch(err){
    document.getElementById("liveStatus").textContent = "Offline";
    showTopError(
      `Data load error:<br><span class="mono">${escapeHtml(err.message || String(err))}</span><br><br>
       Tip: open your CSV URL directly and confirm it shows comma-separated text with headers + rows.`
    );
    // keep UI but show empty
    STATE.rows = [];
    STATE.lastUpdated = new Date();
    setUpdated();
    renderStandings();
    renderDetail();
    document.getElementById("upcoming").innerHTML = `<div class="empty" style="width:100%;">Couldn’t load data. Try Refresh now.</div>`;
  }
}

document.getElementById("refreshBtn").addEventListener("click", build);
document.getElementById("clearBtn").addEventListener("click", () => {
  STATE.selectedPlayer = null;
  renderStandings();
  renderDetail();
});
document.getElementById("search").addEventListener("input", renderStandings);

// run once + auto refresh
build();
setInterval(build, 30000);
</script>
</body>
</html>
