<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantasy Box Office League</title>
  <style>
    :root{
      --bg1:#070816;
      --bg2:#06111a;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --text:#eef0ff;
      --muted:rgba(238,240,255,.65);
      --good:#39d98a;
      --bad:#ff4d6d;
      --chip:rgba(0,0,0,.28);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(130,66,255,.40), transparent 55%),
        radial-gradient(1000px 650px at 80% 20%, rgba(0,210,255,.25), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(255,72,124,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:28px 18px 60px;
    }
    .shell{max-width:1180px;margin:0 auto;}
    .hero{
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      border-radius: 34px;
      padding: 26px 26px 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .kicker{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(238,240,255,.7);
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good); box-shadow:0 0 0 4px rgba(57,217,138,.15);}
    h1{margin:0;font-size:44px;line-height:1.04;}
    .sub{margin:10px 0 0;color:var(--muted);max-width:760px;}
    .topbar{
      margin-top:16px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .chips{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--chip);
      color:rgba(238,240,255,.85);
      font-size:13px;
      backdrop-filter: blur(10px);
    }
    .chip .miniDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);}
    button{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      transition:.15s transform, .15s background;
    }
    button:hover{transform:translateY(-1px);background: rgba(255,255,255,.12);}
    button:active{transform:translateY(0px);}
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr; }
    }
    .panel{
      background: linear-gradient(135deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
    }
    .panel h2{
      margin:0;
      font-size:18px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .panel .hint{margin-top:2px;color:var(--muted);font-size:13px;}
    .search{
      margin-top:12px;
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    .list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 520px;
      overflow:auto;
      padding-right:6px;
    }
    .row{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.15s background, .15s transform, .15s border-color;
    }
    .row:hover{background: rgba(0,0,0,.27); transform: translateY(-1px);}
    .row.active{border-color: rgba(130,66,255,.55); box-shadow: 0 0 0 3px rgba(130,66,255,.18) inset;}
    .row .meta{display:flex;flex-direction:column;gap:2px;}
    .row .name{font-weight:700;}
    .row .mini{font-size:12px;color:var(--muted);}
    .money{font-weight:800;}
    .money.good{color:var(--good);}
    .money.bad{color:var(--bad);}
    .detailHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .detailHead h3{margin:0;font-size:20px;}
    .detailHead .total{font-weight:900;color:var(--muted);}
    .empty{
      margin-top:12px;
      padding:16px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.18);
      color:rgba(238,240,255,.65);
      background: rgba(0,0,0,.18);
    }

    /* Movie cards */
    .sectionTitle{
      margin:18px 0 8px;
      letter-spacing:.12em;
      font-size:12px;
      text-transform:uppercase;
      color:rgba(238,240,255,.55);
    }
    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){
      .cards{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 520px){
      .cards{grid-template-columns: 1fr;}
    }
    .card{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      position:relative;
      min-height: 250px;
    }

    /* poster aspect ratio = 2:3 (taller) */
    .poster{
      width:100%;
      aspect-ratio: 2 / 3;
      background: rgba(255,255,255,.06);
      display:block;
      object-fit: cover;
    }
    .badge{
      position:absolute;
      top:10px; left:10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.16);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      backdrop-filter: blur(10px);
    }
    .badge.bomb{border-color: rgba(255,77,109,.45); color: rgba(255,220,228,.95);}
    .badge.hit{border-color: rgba(57,217,138,.35); color: rgba(210,255,236,.95);}
    .cardBody{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title{
      font-weight:800;
      line-height:1.15;
      font-size:14px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height: 34px;
    }
    .subrow{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      color:rgba(238,240,255,.72);
      font-size:12px;
    }
    .delta{font-weight:800;}
    .delta.good{color:var(--good);}
    .delta.bad{color:var(--bad);}

    /* Upcoming scroller */
    .upcoming{
      margin-top:16px;
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.045));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:14px 14px 10px;
      box-shadow: 0 14px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
    }
    .upcomingHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .upcomingHead h2{margin:0;font-size:18px;}
    .upcomingHead .hint{margin:0;color:var(--muted);font-size:13px;}
    .rail{
      margin-top:10px;
      display:flex;
      gap:12px;
      overflow:auto;
      padding-bottom:8px;
      scroll-snap-type:x mandatory;
    }
    .pill{
      flex:0 0 220px;
      scroll-snap-align:start;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      position:relative;
      min-height: 320px;
    }
    .pill .poster{aspect-ratio: 2 / 3;}
    .dateChip{
      position:absolute;
      top:10px; right:10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.16);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      backdrop-filter: blur(10px);
    }

    .footerNote{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      color:rgba(238,240,255,.45);
      font-size:12px;
    }
    a{color:inherit}
  </style>
</head>
<body>
  <div class="shell">
    <div class="hero">
      <div class="kicker"><span class="dot"></span> Q1 • SPLIT BOMBS • LIVE STANDINGS</div>
      <h1>Fantasy Box Office League</h1>
      <p class="sub">Hits earn their own profit. Bombs are split across opponents.</p>

      <div class="topbar">
        <div class="chips">
          <span class="chip"><span class="miniDot" style="background:var(--good)"></span> <span id="statusText">Live</span></span>
          <span class="chip"><span class="miniDot"></span> Updated: <span id="updatedText">—</span></span>
          <span class="chip"><span class="miniDot"></span> <span id="countText">0</span> players</span>
        </div>
        <div class="actions">
          <button id="refreshBtn">⟳ Refresh now</button>
          <button id="clearBtn">× Clear selection</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Standings <span id="standingsMeta" class="hint"></span></h2>
        <div class="hint">Tap a player to expand</div>
        <input class="search" id="search" placeholder="Search players..." />
        <div class="list" id="standingsList"></div>
      </div>

      <div class="panel" id="detailPanel">
        <div class="detailHead">
          <div>
            <h3 id="detailName">Select a player</h3>
            <div class="hint">Their roster will appear here.</div>
          </div>
          <div class="total" id="detailTotal"></div>
        </div>

        <div id="detailBody" class="empty">
          Pick someone on the left to view their hits + bombs.
        </div>
      </div>
    </div>

    <div class="upcoming">
      <div class="upcomingHead">
        <div>
          <h2>Upcoming Releases</h2>
          <p class="hint">Only chosen, unreleased movies. Bombs show as "Bomb".</p>
        </div>
      </div>
      <div class="rail" id="upcomingRail"></div>
      <div class="footerNote">
        <div>Hosted on GitHub Pages </div>
        <div>Auto-refresh: every <b>30s</b> • Cache-bust enabled</div>
      </div>
    </div>
  </div>

<script>
/**
 * REQUIRED:
 * 1) Publish your API tab as CSV (this is your roster export)
 * 2) Publish your MOVIES tab as CSV (for release dates + profits by title)
 */
const API_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8g_VBKkleUsEkvhsj-Gs4Xsk5k9RifmPFUHw8Yq0_K5X8cca9p1or8TBNI5UbfglWT-A6uVSed_tX/pub?gid=784663852&single=true&output=csv";

const MOVIES_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8g_VBKkleUsEkvhsj-Gs4Xsk5k9RifmPFUHw8Yq0_K5X8cca9p1or8TBNI5UbfglWT-A6uVSed_tX/pub?gid=29963569&single=true&output=csv";

/* ------------------ helpers ------------------ */

function num(v){
  const s0 = String(v ?? "").trim();
  if(!s0) return 0;

  const negParen = /^\((.*)\)$/.test(s0);
  const s1 = negParen ? s0.replace(/^\(|\)$/g,"") : s0;

  const m = s1.match(/^(-?\$?\s*\d+(\.\d+)?)(\s*[kmb])$/i);
  if(m){
    const base = parseFloat(m[1].replace(/\$/g,"").trim());
    const suf = m[3].trim().toUpperCase();
    const mult = suf==="K" ? 1e3 : suf==="M" ? 1e6 : 1e9;
    const out = (isNaN(base) ? 0 : base*mult);
    return negParen ? -out : out;
  }

  const cleaned = s1
    .replace(/\$/g,"")
    .replace(/,/g,"")
    .replace(/\s+/g,"");

  const n = parseFloat(cleaned);
  if (isNaN(n)) return 0;
  return negParen ? -n : n;
}

function formatMoney(n){
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(n);
  if(abs >= 1e9) return `${sign}$${(abs/1e9).toFixed(2)}B`;
  if(abs >= 1e6) return `${sign}$${(abs/1e6).toFixed(1)}M`;
  if(abs >= 1e3) return `${sign}$${(abs/1e3).toFixed(1)}K`;
  return `${sign}$${abs.toFixed(0)}`;
}

function normKey(s){
  return String(s ?? "")
    .toLowerCase()
    .trim()
    .replace(/\u00a0/g," ")
    .replace(/['']/g,"'")
    .replace(/[""]/g,'"')
    .replace(/[‐-‒–—]/g,"-")
    .replace(/[：]/g,":")
    .replace(/\s*:\s*/g,":")
    .replace(/\s+/g," ")
    .replace(/[^a-z0-9: -]/g,"")
    .trim();
}

function parseCSV(text){
  const rows = [];
  let cur = [], field = "", inQuotes = false;
  for(let i=0;i<text.length;i++){
    const c = text[i];
    if(c === '"'){
      if(inQuotes && text[i+1] === '"'){ field += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(c === "," && !inQuotes){
      cur.push(field); field="";
    } else if((c === "\n" || c === "\r") && !inQuotes){
      if(c === "\r" && text[i+1] === "\n") i++;
      cur.push(field); field="";
      if(cur.some(x => String(x).trim() !== "")) rows.push(cur);
      cur = [];
    } else {
      field += c;
    }
  }
  cur.push(field);
  if(cur.some(x => String(x).trim() !== "")) rows.push(cur);
  return rows;
}

function toObjects(csvText){
  const rows = parseCSV(csvText);
  if(rows.length < 2) return [];

  const header = rows[0].map(h => String(h ?? "").replace(/^\uFEFF/,"").trim().toLowerCase());

  return rows.slice(1).map(r => {
    const o = {};
    header.forEach((h,i)=> o[h] = String(r[i] ?? "").trim());
    return o;
  });
}

function parseDateAny(v){
  const s = String(v ?? "").trim();
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function fmtShortDate(d){
  if(!d) return "—";
  return d.toLocaleDateString(undefined, { month:"short", day:"numeric" });
}

function safeImg(url){
  const u = String(url ?? "").trim();
  return u ? u : "";
}

/* ------------------ data loading ------------------ */

let state = {
  players: [],
  moviesMap: new Map(),
  selected: null
};

async function fetchText(url){
  // Use CORS proxy to bypass GitHub Pages CSP restrictions
  const corsProxy = "https://api.allorigins.win/raw?url=";
  const u = corsProxy + encodeURIComponent(url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now());
  const res = await fetch(u, { cache:"no-store" });
  if(!res.ok) throw new Error("Fetch failed: " + res.status);
  return await res.text();
}

async function loadAll(){
  const statusText = document.getElementById("statusText");
  statusText.textContent = "Loading…";

  const [apiText, moviesText] = await Promise.all([
    fetchText(API_CSV_URL),
    MOVIES_CSV_URL.startsWith("PASTE_") ? Promise.resolve("") : fetchText(MOVIES_CSV_URL),
  ]);

  const apiRows = toObjects(apiText);

  if(!apiRows.length || !Object.keys(apiRows[0]).some(h => h.toLowerCase() === "player")){
    const found = Object.keys(apiRows[0] || {}).join(", ");
    throw new Error(`CSV header missing "player". Found: ${found || "(none)"}`);
  }

  const moviesMap = new Map();

  if(moviesText){
    const mRows = toObjects(moviesText);

    const pickCol = (row, names) => {
      for (const n of names){
        if (row[n] !== undefined) return n;
      }
      return null;
    };

    const first = mRows[0] || {};
    const movieCol  = pickCol(first, ["movie","title","film"]);
    const keyCol    = pickCol(first, ["key","movie_key"]);
    const profitCol = pickCol(first, ["profit to date","profit_to_date","profit","profit (usd)","profitusd"]);
    const dateCol   = pickCol(first, ["release date","release_date","releasedate","date"]);
    const posterCol = pickCol(first, ["poster url","poster_url","poster","posterurl"]);

    for(const r of mRows){
      const movieTitle = movieCol ? r[movieCol] : "";
      const keyValue   = keyCol ? r[keyCol] : "";

      const meta = {
        title: movieTitle,
        poster: posterCol ? r[posterCol] : "",
        releaseDate: parseDateAny(dateCol ? r[dateCol] : ""),
        profit: num(profitCol ? r[profitCol] : 0),
      };

      const tKey = normKey(movieTitle);
      const kKey = normKey(keyValue);

      if (tKey) moviesMap.set(tKey, meta);
      if (kKey) moviesMap.set(kKey, meta);
    }
  }

  state.moviesMap = moviesMap;

  // PROCESS API ROWS INTO PLAYERS
  const players = [];
  
  for(const row of apiRows){
    const playerName = row.player || "";
    if(!playerName) continue;

    const hits = [];
    const bombs = [];

    // Process hits (hit1, hit2, hit3, etc.)
    for(let i = 1; i <= 20; i++){
      const hitKey = `hit${i}`;
      const posterKey = `hit${i}_poster`;
      const title = row[hitKey];
      
      if(title && title.trim()){
        hits.push({
          title: title.trim(),
          poster: row[posterKey] || ""
        });
      }
    }

    // Process bombs ASSIGNED TO this player (bomb1, bomb2, bomb3, etc.)
    const assignedBombs = [];
    for(let i = 1; i <= 20; i++){
      const bombKey = `bomb${i}`;
      const posterKey = `bomb${i}_poster`;
      const title = row[bombKey];
      
      if(title && title.trim()){
        assignedBombs.push({
          title: title.trim(),
          poster: row[posterKey] || ""
        });
      }
    }

    // Calculate hit total (all profits/losses from hits)
    const hitTotal = hits.reduce((sum, h) => sum + lookupProfit(h.title), 0);
    
    players.push({
      player: playerName,
      hits,
      assignedBombs,
      hitTotal,
      total: 0
    });
  }

  // Now calculate each player's bomb exposure
  // Each bomb's loss is split among all players who have it assigned to them
  const numPlayers = players.length;
  
  // Build a map of bomb -> players who have it assigned
  const bombAssignments = new Map();
  for(const p of players){
    for(const bomb of p.assignedBombs){
      const key = normKey(bomb.title);
      if(!bombAssignments.has(key)){
        bombAssignments.set(key, []);
      }
      bombAssignments.get(key).push(p.player);
    }
  }

  // Calculate final totals
  for(const p of players){
    let finalTotal = p.hitTotal;
    
    // Add this player's share of each bomb assigned to them
    for(const bomb of p.assignedBombs){
      const key = normKey(bomb.title);
      const profit = lookupProfit(bomb.title);
      const assignedTo = bombAssignments.get(key) || [];
      
      // Split the bomb's profit/loss among all players it was assigned to
      if(assignedTo.length > 0){
        const share = profit / assignedTo.length;
        finalTotal += share;
      }
    }
    
    p.total = finalTotal;
  }

  players.sort((a, b) => b.total - a.total);

  state.players = players;

  document.getElementById("updatedText").textContent = new Date().toLocaleString();
  document.getElementById("countText").textContent = String(players.length);
  document.getElementById("standingsMeta").textContent = `${players.length} players`;
  statusText.textContent = "Live";

  renderStandings();
  renderUpcoming();
  
  if(state.selected){
    const still = players.find(p => p.player === state.selected.player);
    state.selected = still || null;
    renderDetail();
  } else {
    renderDetail();
  }
}

/* ------------------ rendering ------------------ */

function renderStandings(){
  const list = document.getElementById("standingsList");
  list.innerHTML = "";

  const q = document.getElementById("search").value.trim().toLowerCase();

  state.players.forEach((p, idx) => {
    if(q && !p.player.toLowerCase().includes(q)) return;

    const row = document.createElement("div");
    row.className = "row" + (state.selected && state.selected.player === p.player ? " active" : "");
    row.onclick = () => { state.selected = p; renderStandings(); renderDetail(); };

    const meta = document.createElement("div");
    meta.className = "meta";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = `#${idx+1} ${p.player}`;

    const mini = document.createElement("div");
    mini.className = "mini";
    mini.textContent = `Hits: ${p.hits.length} • Bombs assigned: ${p.assignedBombs.length}`;

    meta.appendChild(name);
    meta.appendChild(mini);

    const money = document.createElement("div");
    money.className = "money " + (p.total >= 0 ? "good" : "bad");
    money.textContent = formatMoney(p.total);

    row.appendChild(meta);
    row.appendChild(money);
    list.appendChild(row);
  });
}

function lookupProfit(title){
  const m = state.moviesMap.get(normKey(title));
  return m ? num(m.profit) : 0;
}

function lookupReleaseDate(title){
  const m = state.moviesMap.get(normKey(title));
  return (m && m.releaseDate) ? m.releaseDate : null;
}

function lookupPosterFallback(title, posterFromApi){
  const m = state.moviesMap.get(normKey(title));
  return safeImg(posterFromApi || (m && m.poster) || "");
}

function isUnreleased(title){
  const rd = lookupReleaseDate(title);
  const now = new Date();
  if(rd) return rd.getTime() > new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

  return lookupProfit(title) === 0;
}

function renderDetail(){
  const nameEl = document.getElementById("detailName");
  const totalEl = document.getElementById("detailTotal");
  const body = document.getElementById("detailBody");

  if(!state.selected){
    nameEl.textContent = "Select a player";
    totalEl.textContent = "";
    body.className = "empty";
    body.textContent = "Pick someone on the left to view their hits + bomb exposure.";
    return;
  }

  const p = state.selected;
  nameEl.textContent = p.player;
  totalEl.textContent = "Total: " + formatMoney(p.total);

  body.className = "";
  body.innerHTML = "";

  const summary = document.createElement("div");
  summary.className = "panel";
  summary.style.padding = "14px";
  summary.style.marginTop = "12px";
  summary.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:16px">${p.player}</div>
        <div style="color:var(--muted);font-size:13px;margin-top:2px">Hits: ${p.hits.length} • Bombs assigned: ${p.assignedBombs.length}</div>
      </div>
      <div style="font-weight:900;font-size:18px;color:${p.total>=0?'var(--good)':'var(--bad)'}">${formatMoney(p.total)}</div>
    </div>
  `;
  body.appendChild(summary);

  const hitsTitle = document.createElement("div");
  hitsTitle.className = "sectionTitle";
  hitsTitle.textContent = "HITS";
  body.appendChild(hitsTitle);

  const hitsWrap = document.createElement("div");
  hitsWrap.className = "cards";
  p.hits.forEach(h => {
    const profit = lookupProfit(h.title);
    const poster = lookupPosterFallback(h.title, h.poster);
    hitsWrap.appendChild(movieCard({
      type:"Hit",
      badgeText: p.player,
      badgeClass:"hit",
      title: h.title,
      poster,
      profit,
      label:"Hit"
    }));
  });
  body.appendChild(hitsWrap);

  // Show bombs assigned to this player
  if(p.assignedBombs.length > 0){
    const bombTitle = document.createElement("div");
    bombTitle.className = "sectionTitle";
    bombTitle.textContent = "BOMBS ASSIGNED TO ME (SPLIT)";
    body.appendChild(bombTitle);

    const bombWrap = document.createElement("div");
    bombWrap.className = "cards";
    p.assignedBombs.forEach(b => {
      const profit = lookupProfit(b.title);
      const poster = lookupPosterFallback(b.title, b.poster);
      bombWrap.appendChild(movieCard({
        type:"Bomb",
        badgeText:"Bomb",
        badgeClass:"bomb",
        title: b.title,
        poster,
        profit,
        label:"My Share"
      }));
    });
    body.appendChild(bombWrap);
  }
}

function movieCard({badgeText, badgeClass, title, poster, profit, label}){
  const c = document.createElement("div");
  c.className = "card";
  const img = document.createElement("img");
  img.className = "poster";
  img.alt = title;
  img.loading = "lazy";
  img.referrerPolicy = "no-referrer";
  img.src = poster || "";
  img.onerror = () => { img.style.display="none"; };

  const badge = document.createElement("div");
  badge.className = "badge " + badgeClass;
  badge.textContent = badgeText;

  const body = document.createElement("div");
  body.className = "cardBody";

  const t = document.createElement("div");
  t.className = "title";
  t.textContent = title;

  const sub = document.createElement("div");
  sub.className = "subrow";

  const left = document.createElement("div");
  left.textContent = label;

  const right = document.createElement("div");
  right.className = "delta " + (profit >= 0 ? "good" : "bad");
  right.textContent = formatMoney(profit);

  sub.appendChild(left);
  sub.appendChild(right);

  body.appendChild(t);
  body.appendChild(sub);

  c.appendChild(img);
  c.appendChild(badge);
  c.appendChild(body);
  return c;
}

function renderUpcoming(){
  const rail = document.getElementById("upcomingRail");
  rail.innerHTML = "";

  const hasMovies = state.moviesMap && state.moviesMap.size > 0;

  const picked = new Map();
  for(const p of state.players){
    // Add hits
    for(const h of p.hits){
      const key = normKey(h.title);
      picked.set(key, {
        title: h.title,
        poster: lookupPosterFallback(h.title, h.poster),
        kind: "Hit",
        ownerLabel: p.player
      });
    }
    // Add assigned bombs
    for(const b of p.assignedBombs){
      const key = normKey(b.title);
      if(!picked.has(key)){
        picked.set(key, {
          title: b.title,
          poster: lookupPosterFallback(b.title, b.poster),
          kind: "Bomb",
          ownerLabel: "Bomb"
        });
      }
    }
  }

  const items = Array.from(picked.values())
    .filter(it => isUnreleased(it.title))
    .map(it => {
      const rd = lookupReleaseDate(it.title);
      return { ...it, releaseDate: rd };
    })
    .sort((a,b)=>{
      const ta = a.releaseDate ? a.releaseDate.getTime() : 9e15;
      const tb = b.releaseDate ? b.releaseDate.getTime() : 9e15;
      return ta - tb;
    });

  if(!items.length){
    const empty = document.createElement("div");
    empty.style.color = "rgba(238,240,255,.6)";
    empty.style.padding = "10px 4px";
    empty.textContent = hasMovies
      ? "No upcoming chosen releases found (check Release Date / Profit settings)."
      : "Set MOVIES_CSV_URL to enable upcoming release dates.";
    rail.appendChild(empty);
    return;
  }

  for(const it of items){
    const pill = document.createElement("div");
    pill.className = "pill";

    const img = document.createElement("img");
    img.className = "poster";
    img.loading = "lazy";
    img.referrerPolicy = "no-referrer";
    img.alt = it.title;
    img.src = it.poster || "";
    img.onerror = ()=>{ img.style.display="none"; };

    const badge = document.createElement("div");
    badge.className = "badge " + (it.kind === "Hit" ? "hit" : "bomb");
    badge.textContent = (it.kind === "Hit") ? it.ownerLabel : "Bomb";

    const dateChip = document.createElement("div");
    dateChip.className = "dateChip";
    dateChip.textContent = it.releaseDate ? fmtShortDate(it.releaseDate) : "—";

    const body = document.createElement("div");
    body.className = "cardBody";

    const t = document.createElement("div");
    t.className = "title";
    t.textContent = it.title;

    const sub = document.createElement("div");
    sub.className = "subrow";
    sub.innerHTML = `<div>${it.kind}</div><div style="color:rgba(238,240,255,.55)">${it.releaseDate ? it.releaseDate.getFullYear() : ""}</div>`;

    body.appendChild(t);
    body.appendChild(sub);

    pill.appendChild(img);
    pill.appendChild(badge);
    pill.appendChild(dateChip);
    pill.appendChild(body);

    rail.appendChild(pill);
  }
}

/* ------------------ events / init ------------------ */

document.getElementById("refreshBtn").addEventListener("click", () => {
  loadAll().catch(showError);
});

document.getElementById("clearBtn").addEventListener("click", () => {
  state.selected = null;
  renderStandings();
  renderDetail();
});

document.getElementById("search").addEventListener("input", renderStandings);

function showError(err){
  document.getElementById("statusText").textContent = "Error";
  document.getElementById("updatedText").textContent = "—";
  const hero = document.querySelector(".hero");
  const box = document.createElement("div");
  box.style.marginTop = "12px";
  box.style.padding = "12px 14px";
  box.style.borderRadius = "18px";
  box.style.border = "1px solid rgba(255,77,109,.35)";
  box.style.background = "rgba(255,77,109,.10)";
  box.style.color = "rgba(255,220,228,.95)";
  box.innerHTML = `<b>Data load error:</b><br>${String(err.message || err)}<br><br><span style="color:rgba(238,240,255,.65)">Tip: open your CSV URL directly and confirm it shows comma-separated text with headers + rows.</span>`;
  hero.querySelectorAll(".errbox").forEach(n=>n.remove());
  box.className = "errbox";
  hero.appendChild(box);
  console.error(err);
}

loadAll().catch(showError);
setInterval(() => loadAll().catch(showError), 30000);
</script>
</body>
</html>
