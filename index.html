<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fantasy Box Office League</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

<div id="app"></div>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/16jfz5_VxPn4AYs1riL9rwTlX9AtvWGXe8D8K-XG87i0/gviz/tq?tqx=out:csv&sheet=API";

function parseCSV(text){
  const rows=[], row=[], cur={v:""}, out=[];
  let inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c=='"' && inQ && n=='"'){ cur.v+='"'; i++; continue; }
    if(c=='"'){ inQ=!inQ; continue; }
    if(c==',' && !inQ){ row.push(cur.v); cur.v=""; continue; }
    if((c=='\n'||c=='\r') && !inQ){
      if(c=='\r' && n=='\n') i++;
      row.push(cur.v); out.push(row.splice(0)); cur.v=""; continue;
    }
    cur.v+=c;
  }
  row.push(cur.v); out.push(row);
  return out.filter(r=>r.some(x=>x!==""));
}

function money(n){
  const v=Number(n||0), a=Math.abs(v), s=v<0?"-":"";
  if(a>=1e9) return s+"$"+(a/1e9).toFixed(2)+"B";
  if(a>=1e6) return s+"$"+(a/1e6).toFixed(1)+"M";
  if(a>=1e3) return s+"$"+(a/1e3).toFixed(1)+"K";
  return s+"$"+a.toFixed(0);
}

function build(){
  const url = SHEET_CSV_URL + "&cb=" + Date.now();

  fetch(url, { cache:"no-store" })
    .then(r=>r.text())
    .then(csv=>{
      const rows=parseCSV(csv);
      const header=rows[0].map(h=>h.trim());
      const data=rows.slice(1).map(r=>{
        const o={};
        header.forEach((h,i)=>o[h]=(r[i]||"").trim());
        return o;
      });

      data.sort((a,b)=>Number(b.total||0)-Number(a.total||0));

      let html = `<h1>Fantasy Box Office League</h1><p>Updated: ${new Date().toLocaleString()}</p><hr>`;

      data.forEach((p,i)=>{
        html += `
          <h2>#${i+1} ${p.player} â€” ${money(p.total)}</h2>
          <strong>Hits:</strong><br>
          <img src="${p.hit1_poster}" width="120">
          <img src="${p.hit2_poster}" width="120">
          <img src="${p.hit3_poster}" width="120">
          <br><br>
          <strong>Bomb Exposure (1/6 each):</strong><br>
          <img src="${p.bomb1_poster}" width="90">
          <img src="${p.bomb2_poster}" width="90">
          <img src="${p.bomb3_poster}" width="90">
          <img src="${p.bomb4_poster}" width="90">
          <img src="${p.bomb5_poster}" width="90">
          <img src="${p.bomb6_poster}" width="90">
          <hr>
        `;
      });

      document.getElementById("app").innerHTML = html;
    })
    .catch(e=>{
      document.getElementById("app").innerHTML = "Error loading data.";
      console.error(e);
    });
}

build();
setInterval(build, 30000); // auto-refresh every 30 seconds
</script>

</body>
</html>
