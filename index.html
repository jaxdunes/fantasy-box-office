<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantasy Box Office League</title>
  <style>
    :root{
      --bg:#070912;
      --panel:rgba(18,22,38,.60);
      --panel2:rgba(18,22,38,.42);
      --border:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.44);
      --accent:#8b5cf6;
      --good:#22c55e;
      --shadow: 0 18px 70px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(139,92,246,.35), transparent 55%),
        radial-gradient(900px 700px at 70% 15%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(1100px 700px at 45% 70%, rgba(99,102,241,.18), transparent 62%),
        linear-gradient(180deg, #070912 0%, #050612 100%);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px}
    .hero{
      border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(139,92,246,.14), rgba(255,255,255,.03));
      border-radius:28px;
      padding:22px 22px 18px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .kicker{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .dot{width:7px;height:7px;border-radius:50%;background:var(--good);box-shadow:0 0 0 4px rgba(34,197,94,.12)}
    h1{margin:10px 0 8px;font-size:40px;line-height:1.05}
    .sub{margin:0;color:var(--muted);max-width:72ch;font-size:14px}
    .bar{
      margin-top:14px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .chips{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      display:flex;align-items:center;gap:8px;
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      transition:.15s ease;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    button:active{transform:translateY(0px)}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      align-items:start;
    }
    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:0 10px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card .title{
      font-weight:700;
      font-size:13px;
      letter-spacing:.02em;
    }
    .card .hint{font-size:12px;color:var(--muted)}
    .card .body{padding:12px 14px 14px}
    .search{
      width:100%;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
      margin-top:10px;
    }
    .list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .row{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      transition:.15s ease;
    }
    .row:hover{background:rgba(255,255,255,.05)}
    .row.active{outline:2px solid rgba(139,92,246,.35);background:rgba(139,92,246,.08)}
    .who{display:flex;flex-direction:column;gap:2px}
    .name{font-weight:750;font-size:13px}
    .mini{font-size:12px;color:var(--muted)}
    .score{
      font-variant-numeric: tabular-nums;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
    }
    .detailTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .detailName{font-weight:850;font-size:18px}
    .detailMeta{color:var(--muted);font-size:12px;margin-top:2px}
    .bigScore{font-weight:900;font-size:22px}
    .section{margin-top:14px}
    .label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
      margin-bottom:8px;
    }
    .posterGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .poster{
      border:1px solid var(--border);
      background:rgba(0,0,0,.16);
      border-radius:16px;
      overflow:hidden;
      min-height:140px;
      position:relative;
    }
    .poster img{
      width:100%;
      height:170px;
      object-fit:cover;
      display:block;
      filter:saturate(1.02) contrast(1.02);
    }
    .poster .cap{
      padding:9px 10px 10px;
      font-size:12px;
      color:var(--text);
      line-height:1.25;
      min-height:42px;
    }
    .poster .cap .subcap{display:block;color:var(--muted2);font-size:11px;margin-top:2px}
    .mutedLine{margin-top:10px;color:var(--muted2);font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .debug{color:#fca5a5;font-size:12px;margin-top:8px;white-space:pre-wrap}
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="kicker"><span class="dot"></span> Q1 • SPLIT BOMBS • LIVE STANDINGS</div>
      <h1>Fantasy Box Office League</h1>
      <p class="sub">Scores update from your Google Sheet. Hits earn their own profit. Bombs are split across opponents (negative exposure).</p>
      <div class="bar">
        <div class="chips">
          <div class="chip">● <span id="fbo-status">Live</span></div>
          <div class="chip" id="fbo-updated">Updated: —</div>
          <div class="chip" id="fbo-count">0 players</div>
        </div>
        <div class="btns">
          <button id="btn-refresh">↻ Refresh now</button>
          <button id="btn-clear">× Clear selection</button>
        </div>
      </div>
      <div id="fbo-debug" class="debug" style="display:none;"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <div>
            <div class="title">Standings</div>
            <div class="hint">Tap a player to expand</div>
          </div>
          <div class="hint" id="standings-meta"></div>
        </div>
        <div class="body">
          <input class="search" id="search" placeholder="Search players..." />
          <div class="list" id="standings"></div>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <div class="title">Select a player</div>
            <div class="hint">Their roster will appear here.</div>
          </div>
          <div class="hint" id="detail-rank"></div>
        </div>
        <div class="body" id="detail">
          <div class="hint">Pick someone on the left to view their hits + bomb exposure.</div>
        </div>
      </div>
    </div>

    <div class="mutedLine">
      <span>Hosted on GitHub Pages · Dark / Cinematic theme</span>
      <span>Auto-refresh: every 30s · Cache-bust enabled</span>
    </div>
  </div>

  <script>
    // ✅ Your published CSV
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8g_VBKkleUsEkvhsj-Gs4Xsk5k9RifmPFUHw8Yq0_K5X8cca9p1or8TBNI5UbfglWT-A6uVSed_tX/pub?gid=784663852&single=true&output=csv";

    // ---------- Robust CSV parser (handles quotes, commas, empty fields, CRLF) ----------
    function parseCSV(text){
      text = (text || "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      const rows = [];
      let row = [];
      let field = "";
      let i = 0;
      let inQuotes = false;

      while (i < text.length) {
        const c = text[i];

        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else {
            field += c; i++; continue;
          }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ",") { row.push(field); field=""; i++; continue; }
          if (c === "\n") { row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
          field += c; i++; continue;
        }
      }
      // last field
      row.push(field);
      rows.push(row);

      // trim trailing empty row
      while (rows.length && rows[rows.length-1].every(v => (v||"").trim() === "")) rows.pop();
      return rows;
    }

    function money(n){
      const v = Number(n || 0);
      const sign = v < 0 ? "-" : "";
      const abs = Math.abs(v);
      if (abs >= 1e9) return sign + "$" + (abs/1e9).toFixed(2) + "B";
      if (abs >= 1e6) return sign + "$" + (abs/1e6).toFixed(1) + "M";
      if (abs >= 1e3) return sign + "$" + (abs/1e3).toFixed(1) + "K";
      return sign + "$" + abs.toFixed(0);
    }

    function safeStr(s){ return (s ?? "").toString().trim(); }
    function safeImg(url){ return safeStr(url) || ""; }

    function buildCard(title, posterUrl, sub){
      const div = document.createElement("div");
      div.className = "poster";

      const img = document.createElement("img");
      const src = safeImg(posterUrl);
      if (src) img.src = src;
      else {
        img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="600" height="900">
            <defs>
              <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#111827"/>
                <stop offset="1" stop-color="#0b1025"/>
              </linearGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#g)"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
              fill="rgba(255,255,255,.35)" font-family="system-ui" font-size="28">No poster</text>
          </svg>
        `);
      }

      const cap = document.createElement("div");
      cap.className = "cap";
      cap.textContent = title || "—";
      if (sub){
        const s = document.createElement("span");
        s.className = "subcap";
        s.textContent = sub;
        cap.appendChild(s);
      }

      div.appendChild(img);
      div.appendChild(cap);
      return div;
    }

    // ---------- Render ----------
    let STATE = { data: [], selected: null, filter: "" };

    function renderStandings(){
      const el = document.getElementById("standings");
      el.innerHTML = "";

      const q = STATE.filter.toLowerCase().trim();
      const list = STATE.data.filter(p => !q || p.player.toLowerCase().includes(q));

      document.getElementById("fbo-count").textContent = `${STATE.data.length} players`;
      document.getElementById("standings-meta").textContent = q ? `${list.length} shown` : "";

      list.forEach((p, idx) => {
        const row = document.createElement("div");
        row.className = "row" + (STATE.selected && STATE.selected.player === p.player ? " active" : "");
        row.onclick = () => { STATE.selected = p; renderStandings(); renderDetail(); };

        const left = document.createElement("div");
        left.className = "who";
        left.innerHTML = `<div class="name">#${p.rank} ${p.player}</div>
                          <div class="mini">Hits: ${p.hitsCount} · Bombs: ${p.bombsCount}</div>`;
        const right = document.createElement("div");
        right.className = "score";
        right.textContent = money(p.total);

        row.appendChild(left);
        row.appendChild(right);
        el.appendChild(row);
      });
    }

    function renderDetail(){
      const el = document.getElementById("detail");
      el.innerHTML = "";
      const p = STATE.selected;

      if (!p){
        el.innerHTML = `<div class="hint">Pick someone on the left to view their hits + bomb exposure.</div>`;
        document.getElementById("detail-rank").textContent = "";
        return;
      }

      document.getElementById("detail-rank").textContent = `#${p.rank}`;

      const top = document.createElement("div");
      top.className = "detailTop";
      top.innerHTML = `
        <div>
          <div class="detailName">${p.player}</div>
          <div class="detailMeta">Hits earn full profit. Bomb exposure is split evenly.</div>
        </div>
        <div class="bigScore">${money(p.total)}</div>
      `;
      el.appendChild(top);

      // Hits
      const hitsWrap = document.createElement("div");
      hitsWrap.className = "section";
      hitsWrap.innerHTML = `<div class="label">Hits</div>`;
      const hitsGrid = document.createElement("div");
      hitsGrid.className = "posterGrid";
      p.hits.forEach((m, i) => {
        hitsGrid.appendChild(buildCard(m.title, m.poster, `Pick #${i+1}`));
      });
      hitsWrap.appendChild(hitsGrid);
      el.appendChild(hitsWrap);

      // Bomb exposure
      const bombsWrap = document.createElement("div");
      bombsWrap.className = "section";
      bombsWrap.innerHTML = `<div class="label">Bomb exposure (${p.bombShareLabel})</div>`;
      const bombsGrid = document.createElement("div");
      bombsGrid.className = "posterGrid";
      p.bombs.forEach((m, i) => {
        bombsGrid.appendChild(buildCard(m.title, m.poster, `Exposure #${i+1}`));
      });
      bombsWrap.appendChild(bombsGrid);
      el.appendChild(bombsWrap);
    }

    // ---------- Data load ----------
    function normalizeHeader(h){
      return (h || "").trim().toLowerCase();
    }

    function rowObjFrom(header, row){
      const o = {};
      header.forEach((h, i) => o[h] = (row[i] ?? "").toString().trim());
      return o;
    }

    function extractMovies(o, prefix, count){
      const arr = [];
      for (let i=1;i<=count;i++){
        const t = safeStr(o[`${prefix}${i}`]);
        const p = safeStr(o[`${prefix}${i}_poster`]);
        if (t) arr.push({ title: t, poster: p });
      }
      return arr;
    }

    async function build(){
      const debugEl = document.getElementById("fbo-debug");
      debugEl.style.display = "none";
      debugEl.textContent = "";

      const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();

      try{
        const res = await fetch(url, { cache: "no-store" });
        const text = await res.text();

        if (text.trim().startsWith("<")) {
          throw new Error("Your CSV URL returned HTML (not CSV). Re-publish the API tab to web as CSV.");
        }

        const rows = parseCSV(text);
        if (!rows || rows.length < 2) {
          throw new Error("CSV loaded but has no data rows.");
        }

        const header = rows[0].map(normalizeHeader);
        const dataRows = rows.slice(1).filter(r => r.some(x => (x||"").trim() !== ""));

        // required columns sanity
        if (!header.includes("player")) {
          throw new Error(`CSV header missing "player". Found: ${header.join(", ")}`);
        }

        let players = dataRows.map(r => rowObjFrom(header, r))
          .map(o => {
            const hits = extractMovies(o, "hit", 3);
            const bombs = extractMovies(o, "bomb", 6);
            const total = Number(o.total || 0);
            const hitsCount = hits.length;
            const bombsCount = bombs.length;
            const bombShareLabel = bombsCount ? `1/${bombsCount} each` : "—";
            return {
              player: safeStr(o.player),
              total,
              hit_points: Number(o.hit_points || 0),
              bomb_points: Number(o.bomb_points || 0),
              hits, bombs, hitsCount, bombsCount, bombShareLabel
            };
          })
          .filter(p => p.player);

        players.sort((a,b) => Number(b.total||0) - Number(a.total||0));
        players = players.map((p, i) => ({...p, rank: i+1}));

        STATE.data = players;

        document.getElementById("fbo-updated").textContent = "Updated: " + new Date().toLocaleString();
        renderStandings();
        renderDetail();

      } catch(err){
        console.error(err);
        document.getElementById("fbo-updated").textContent = "Updated: —";
        document.getElementById("fbo-count").textContent = "0 players";
        document.getElementById("standings").innerHTML = "";
        document.getElementById("detail").innerHTML = `<div class="hint">Couldn’t load data. Try Refresh now.</div>`;

        debugEl.style.display = "block";
        debugEl.textContent =
          "Data load error:\n" +
          (err && err.message ? err.message : String(err)) +
          "\n\nTip: open the CSV URL directly and confirm it shows comma-separated text with headers + rows.";
      }
    }

    // UI events
    document.getElementById("search").addEventListener("input", (e)=>{
      STATE.filter = e.target.value || "";
      renderStandings();
    });

    document.getElementById("btn-clear").addEventListener("click", ()=>{
      STATE.selected = null;
      renderStandings();
      renderDetail();
    });

    document.getElementById("btn-refresh").addEventListener("click", ()=>{
      build();
    });

    // boot + auto refresh
    build();
    setInterval(build, 30000);
  </script>
</body>
</html>
